---
import type { Fact } from '../types/fact';
import { getCategoryColor, getWonderScoreOpacity } from '../utils/colors';

export interface Props {
  fact: Fact;
  featured?: boolean;
}

const { fact, featured = false } = Astro.props;
const { id, title, content, category, wonderScore } = fact;

// Use first 200 chars for excerpt
const excerpt = content.substring(0, 200) + (content.length > 200 ? '...' : '');

// Get dynamic colors
const categoryColor = getCategoryColor(category);
const scoreOpacity = getWonderScoreOpacity(wonderScore);
---

<article
  class:list={['fact-card', { featured }]}
  data-fact-id={id}
  data-category={category.toLowerCase()}
  data-fact-url={`/fact/${id}`}
  style={`--card-color: ${categoryColor}; --card-opacity: ${scoreOpacity};`}
  onclick="if (!event.target.closest('.fact-category')) window.location.href = this.dataset.factUrl"
>
  {featured && (
    <div class="featured-label">
      ★ Featured Discovery
    </div>
  )}

  <div class="fact-meta">
    <a href={`/category/${encodeURIComponent(category)}`} class="fact-category" onclick="event.stopPropagation()">{category}</a>
  </div>

  <a href={`/fact/${id}`} class="fact-link">
    <h2 class="fact-title">{title}</h2>
    <p class="fact-excerpt">{excerpt}</p>

    <div class="fact-footer">
      <span class="fact-score"><strong>{wonderScore}</strong></span>
      <span class="read-more">Continue</span>
    </div>
  </a>
</article>

<style>
  .fact-card {
    background: var(--white);
    padding: 2.5rem;
    border: 2px solid var(--grey-lighter);
    transition: transform 0.3s var(--ease-spring), border-color 0.3s ease;
    position: relative;
    display: flex;
    flex-direction: column;
    will-change: transform;
    contain: layout style paint;
    cursor: pointer;
  }

  .fact-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 6px;
    background: var(--card-color, var(--grey-lighter));
    opacity: var(--card-opacity, 0.3);
    transition: opacity 0.3s ease, background 0.3s ease;
  }

  .fact-card:hover {
    border-color: var(--black);
    transform: translate3d(0, -4px, 0) rotate(-1deg);
  }

  .fact-card:hover::before {
    opacity: 1;
  }

  .fact-card:nth-child(2n):hover {
    transform: translate3d(0, -4px, 0) rotate(1deg);
  }

  /* Grid spans for bento box layout */
  /* Row 1: Featured takes full width (12) */
  /* Row 2: Cards 2+3 = 6+6 = 12 */
  /* Row 3: Cards 4+5+6 = 4+4+4 = 12 */
  /* Row 4+: Cards repeat pattern */
  .fact-card:nth-child(1) { grid-column: span 12; }
  .fact-card:nth-child(2) { grid-column: span 6; }
  .fact-card:nth-child(3) { grid-column: span 6; }
  .fact-card:nth-child(4) { grid-column: span 4; }
  .fact-card:nth-child(5) { grid-column: span 4; }
  .fact-card:nth-child(6) { grid-column: span 4; }
  .fact-card:nth-child(7) { grid-column: span 6; }
  .fact-card:nth-child(8) { grid-column: span 6; }
  .fact-card:nth-child(9) { grid-column: span 4; }
  .fact-card:nth-child(10) { grid-column: span 4; }
  .fact-card:nth-child(11) { grid-column: span 4; }
  .fact-card:nth-child(12) { grid-column: span 12; }

  /* Featured card styling */
  .fact-card.featured {
    grid-column: span 12;
    padding: 4rem;
    background: var(--white);
    border: 2px solid var(--black);
    box-shadow: 12px 12px 0 var(--accent-light);
  }

  .fact-card.featured:hover {
    transform: translate3d(-4px, -4px, 0) rotate(-0.5deg);
    box-shadow: 16px 16px 0 var(--accent-light);
  }

  .fact-card.featured::after {
    content: '✦';
    position: absolute;
    top: 2rem;
    right: 2rem;
    font-size: 2rem;
    color: var(--accent);
    opacity: 0.15;
    animation: spin 20s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .featured-label {
    font-family: var(--mono);
    font-size: 0.6875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--accent);
    font-weight: 700;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .fact-link {
    display: block;
    text-decoration: none;
    color: inherit;
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  .fact-meta {
    font-family: var(--mono);
    font-size: 0.6875rem;
    color: var(--grey-light);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 1.25rem;
    font-weight: 400;
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .fact-category {
    color: var(--accent);
    font-weight: 700;
    text-decoration: none;
    transition: opacity 0.3s ease;
    display: inline-block;
  }

  .fact-category:hover {
    opacity: 0.7;
    text-decoration: underline;
  }

  /* Ensure category link is on top and clickable */
  .fact-category {
    position: relative;
    z-index: 2;
    cursor: pointer;
  }

  .fact-title {
    font-family: var(--serif);
    font-size: 1.625rem;
    font-weight: 400;
    line-height: 1.35;
    margin-bottom: 1.25rem;
    color: var(--black);
    letter-spacing: -0.015em;
    font-variation-settings: "opsz" 48;
    transition: color 0.3s;
  }

  .fact-card:hover .fact-title {
    color: var(--card-color, var(--accent));
  }

  .fact-card.featured .fact-title {
    font-size: 2.5rem;
    line-height: 1.3;
    margin-bottom: 1.75rem;
    letter-spacing: -0.02em;
    font-variation-settings: "opsz" 72;
  }

  .fact-excerpt {
    font-family: var(--sans);
    font-size: 0.9375rem;
    line-height: 1.65;
    color: var(--grey);
    margin-bottom: 1.5rem;
    flex-grow: 1;
    font-weight: 400;
  }

  .fact-card.featured .fact-excerpt {
    font-size: 1.125rem;
    line-height: 1.7;
    max-width: 900px;
  }

  .fact-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 1.25rem;
    border-top: 2px solid var(--grey-lighter);
  }

  .fact-score {
    font-family: var(--mono);
    font-size: 0.875rem;
    color: var(--grey);
    font-weight: 400;
  }

  .fact-score strong {
    color: var(--black);
    font-weight: 700;
    font-size: 1.125rem;
    display: inline-block;
    transition: transform 0.3s var(--ease-spring);
  }

  .fact-card:hover .fact-score strong {
    transform: scale(1.15);
    color: var(--card-color, var(--accent));
  }

  .read-more {
    font-family: var(--sans);
    font-size: 0.8125rem;
    color: var(--black);
    font-weight: 700;
    transition: all 0.3s var(--ease-spring);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .read-more::after {
    content: '→';
    font-size: 1.125rem;
    font-weight: 400;
    display: inline-block;
    transition: transform 0.3s var(--ease-spring);
  }

  .fact-card:hover .read-more {
    gap: 0.75rem;
    color: var(--card-color, var(--accent));
  }

  .fact-card:hover .read-more::after {
    transform: translateX(3px);
    animation: bounce 0.6s ease infinite;
  }

  @keyframes bounce {
    0%, 100% { transform: translateX(3px); }
    50% { transform: translateX(6px); }
  }

  @media (max-width: 1024px) {
    .fact-card,
    .fact-card:nth-child(n) {
      grid-column: span 12 !important;
    }
  }

  @media (max-width: 768px) {
    .fact-card,
    .fact-card.featured {
      padding: 2rem;
    }

    .fact-card.featured {
      box-shadow: 8px 8px 0 var(--accent-light);
    }

    .fact-card.featured:hover {
      transform: translate(-2px, -2px) rotate(-0.5deg);
      box-shadow: 10px 10px 0 var(--accent-light);
    }

    .fact-title {
      font-size: 1.5rem;
    }

    .fact-card.featured .fact-title {
      font-size: 2rem;
    }
  }
</style>
